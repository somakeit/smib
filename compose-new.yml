name: smib
services:
  smib:
    container_name: smib
    hostname: smib
    image: smib
    build: ${SMIB_BUILD_GIT_TAG:+https://github.com/somakeit/smib.git#}${SMIB_BUILD_GIT_TAG:-.}
    env_file: .env
    environment:
      MONGO_DB_HOST: ${MONGO_DB_HOST:-smib-db}
    depends_on:
      - smib-db
    restart: unless-stopped
    labels:
      - "traefik.enable=true"

      # API router (with PathPrefix and stripPrefix)
      - "traefik.http.routers.smib.rule=PathPrefix(`${WEBSERVER_PATH_PREFIX:-/}`)"
      - "traefik.http.routers.smib.entrypoints=web"
      - "traefik.http.services.smib.loadbalancer.server.port=${WEBSERVER_PORT:-80}"
      - "traefik.http.middlewares.smib-stripprefix.stripprefix.prefixes=${WEBSERVER_PATH_PREFIX:-/}"
      - "traefik.http.routers.smib.middlewares=smib-stripprefix@docker"
      - "traefik.http.routers.smib.priority=5"   # lower priority for fallback

      # Static files router (no stripPrefix)
      - "traefik.http.routers.smib-static.rule=PathPrefix(`/static`)"
      - "traefik.http.routers.smib-static.entrypoints=web"
      - "traefik.http.routers.smib-static.priority=10"  # higher priority so /static is matched first

    networks:
      - smib-bridge-network

  smib-db:
    image: mongo:${MONGO_DB_TAG:-latest}
    container_name: smib-db
    env_file: .env
    restart: unless-stopped
    networks:
      - smib-bridge-network
    healthcheck:
      test: ["CMD", "mongo", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  smib-db-ui:
    image: mongo-express
    container_name: smib-db-ui
    depends_on:
      - smib-db
    env_file: .env
    environment:
      ME_CONFIG_MONGODB_URL: ${ME_CONFIG_MONGODB_URL:-mongodb://smib-db:27017/}
      ME_CONFIG_SITE_BASEURL: /database/ui
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.smib-db-ui.rule=PathPrefix(`/database/ui`)"
      - "traefik.http.routers.smib-db-ui.entrypoints=web"
    healthcheck:
      test: ["CMD-SHELL", "wget --spider --quiet http://0.0.0.0:8081/database/ui/status || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

    networks:
      - smib-bridge-network

  smib-proxy:
    container_name: smib-proxy
    hostname: smib-proxy
    image: traefik:3
    restart: unless-stopped
    command:
      - --log.level=DEBUG
      - --providers.docker=true
      - --providers.docker.endpoint=tcp://smib-socket-proxy:2375
      - --providers.docker.exposedbydefault=false
      - --entrypoints.web.address=:80
      - --providers.docker.network=smib-bridge-network
      - --api.dashboard=false
      - --api.debug=false
      - --providers.docker.constraints=Label("com.docker.compose.project", "smib")
      - --ping=true
    ports:
      - "${SMIB_PROXY_EXTERNAL_PORT:-80}:80"
    depends_on:
      - smib-socket-proxy
    networks:
      - smib-bridge-network

  smib-socket-proxy:
    container_name: smib-socket-proxy
    image:  tecnativa/docker-socket-proxy:edge
    restart: unless-stopped
    environment:
      - LOG_LEVEL=warning
      - EVENTS=1
      - PING=1
      - VERSION=1
      - CONTAINERS=1
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - smib-bridge-network

networks:
  smib-bridge-network:
    name: smib-bridge-network
    driver: bridge

volumes:
  socket-proxy:
